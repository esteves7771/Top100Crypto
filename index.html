<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 100 Crypto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&display=swap" rel="stylesheet">
    <!-- Luxon is the date adapter library required by Chart.js for the time scale -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <!-- Chart.js for the graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- The Chart.js Luxon adapter to connect the two libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        :root {
            --bg-color: #f7f7f7;
            --text-color: #333;
            --border-color: #e0e0e0;
            --header-bg: #fff;
            --card-bg: #fff;
            --link-color: #007bff;
            --green: #2ecc71;
            --red: #e74c3c;
            --button-bg: #f0f0f0;
            --button-text: #333;
            --chart-text-color: #333;
            --chart-grid-color: #e0e0e0;
        }

        [data-theme='dark'] {
            --bg-color: #121212;
            --text-color: #f7f7f7;
            --border-color: #333;
            --header-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --link-color: #61dafb;
            --button-bg: #333;
            --button-text: #f7f7f7;
            --chart-text-color: #f7f7f7;
            --chart-grid-color: #000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s, opacity 0.3s, transform 0.3s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
        }

        .logo-icon {
            width: 30px;
            height: 30px;
            fill: currentColor;
        }
        
        .logo:hover .logo-icon {
            fill: var(--link-color);
        }
        
        .news-scroll-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: bold;
            transition: color 0.3s;
        }
        
        .news-scroll-button:hover {
            color: var(--link-color);
        }


        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        

        .currency-selector {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .dark-mode-toggle {
            cursor: pointer;
            font-size: 1.5rem;
        }

        main {
            padding: 20px 0;
        }

        .search-container {
            margin-bottom: 20px;
        }

        #search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table-container {
            background-color: var(--card-bg);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            background-color: var(--header-bg);
        }

        th:hover {
            background-color: var(--border-color);
        }
        
        th.active {
            color: var(--link-color);
        }
        
        tr {
            cursor: pointer;
        }

        .sort-icon {
            font-size: 0.7rem;
            margin-left: 5px;
        }

        tr:hover {
            background-color: var(--border-color);
        }

        .coin-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coin-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .coin-symbol {
            color: #888;
            font-size: 0.9rem;
        }

        .positive {
            color: var(--green);
        }

        .negative {
            color: var(--red);
        }

        .sparkline-graph {
            width: 100px;
            height: 30px;
        }

        .loading-state {
            text-align: center;
            padding: 50px;
        }

        footer {
            text-align: center;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: #888;
            margin-top: 20px;
        }

        footer a {
            color: var(--link-color);
            text-decoration: none;
            margin: 0 5px;
        }
        
        footer a:hover {
            text-decoration: underline;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none; /* Hidden by default */
            opacity: 0;
        }
        
        .modal-overlay.visible {
            opacity: 1;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            position: relative;
            color: var(--text-color);
            transform: translateY(-20px);
        }
        
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .modal-content .loading-state {
            padding: 200px;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            border: none;
            background: none;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .timeframe-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .timeframe-buttons button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .timeframe-buttons button.active {
            background-color: var(--link-color);
            color: #fff;
            border-color: var(--link-color);
        }

        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--link-color);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #backToTopBtn:hover {
            background-color: #0056b3;
        }

        /* Mobile Card View */
        .mobile-card-container {
            display: none;
        }

        .coin-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .card-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-name strong {
            font-size: 1.2rem;
        }

        .card-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .card-info-item {
            display: flex;
            flex-direction: column;
        }

        .card-label {
            font-size: 0.8rem;
            color: #888;
        }

        @media (max-width: 768px) {
            .table-wrapper {
                display: none;
            }
            .mobile-card-container {
                display: block;
            }
            header {
                padding: 15px;
            }
            .container {
                padding: 10px;
            }
        }

        .news-section {
            margin-top: 40px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .news-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
            list-style: none;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .news-list.visible {
            max-height: 2000px; /* Adjust as needed */
        }
        
        .news-item-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--button-bg);
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        
        .news-item-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .news-item-card h4 {
            font-size: 1rem;
            padding: 10px;
        }
        
        .news-item-card p {
            font-size: 0.8rem;
            color: #888;
            padding: 0 10px 10px;
        }
        
        .news-loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <div class="logo">
                    <!-- New Minimalist Digital Coin SVG Logo -->
                    <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8l4 4-4 4-4-4z"></path>
                    </svg>
                    Top100Crypto
                </div>
            </div>
            <div class="header-right">
                <button class="news-scroll-button" id="news-scroll-button">News</button>
                <select id="currencySelector" class="currency-selector">
                    <option value="eur">EUR</option>
                    <option value="usd">USD</option>
                    <option value="gbp">GBP</option>
                    <option value="jpy">JPY</option>
                    <option value="aud">AUD</option>
                </select>
                <div class="dark-mode-toggle" id="darkModeToggle">üåô</div>
            </div>
        </header>

        <main>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search for a coin...">
            </div>
            <div id="loading" class="loading-state">Loading data...</div>
            
            <!-- This container is for the desktop table view -->
            <div id="desktop-view" class="table-wrapper" style="display: none;">
                <div id="table-content" class="table-container">
                    <table id="cryptoTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th id="sort-name">Coin <span class="sort-icon"></span></th>
                                <th id="sort-price">Price (<span id="currency-symbol-header">‚Ç¨</span>) <span class="sort-icon"></span></th>
                                <th id="sort-24h">24h % <span class="sort-icon"></span></th>
                                <th id="sort-7d" class="hide-on-mobile">7d % <span class="sort-icon"></span></th>
                                <th id="sort-market_cap" class="hide-on-mobile">Market Cap <span class="sort-icon"></span></th>
                                <th id="sort-volume" class="hide-on-mobile">Volume 24h <span class="sort-icon"></span></th>
                                <th>Graph (7d)</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoBody">
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- This container is for the mobile card view -->
            <div id="mobile-view" class="mobile-card-container" style="display: none;">
                <!-- Mobile cards will be populated here -->
            </div>

            <!-- News Feed Section -->
            <div id="news-section" class="news-section">
                <div id="news-header" class="news-header">
                    <span>Latest Crypto News</span>
                    <span id="news-toggle-icon">+</span>
                </div>
                <div id="news-list-container" class="news-list">
                    <div id="news-loading" class="news-loading">Loading news...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- The Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeModal" class="close-button">&times;</button>
            <h2 id="modalTitle"></h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- The Graph Modal -->
    <div id="graphModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeGraphModal" class="close-button">&times;</button>
            <h2 id="graphTitle"></h2>
            <div class="timeframe-buttons" id="timeframeButtons">
                <button data-days="1">1D</button>
                <button data-days="7" class="active">7D</button>
                <button data-days="30">1M</button>
                <button data-days="365">1Y</button>
                <button data-days="max">All</button>
            </div>
            <div id="graph-loading" class="loading-state">Loading graph...</div>
            <div id="chart-container" class="chart-container" style="display: none;">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    
    <button id="backToTopBtn" title="Go to top">&#x2191;</button>

    <footer>
        <p>
            Disclaimer: Not financial advice. Data from 
            <a href="https://www.coingecko.com/" target="_blank">CoinGecko API</a>.
        </p>
        <p>
            <a href="#" id="about-link">About</a> | 
            <a href="#" id="contact-link">Contact</a> | 
            <a href="#" id="terms-link">Terms</a>
        </p>
    </footer>

    <script>
        // Global variables for currency and symbols
        const currencySymbols = { 'eur': '‚Ç¨', 'usd': '$', 'gbp': '¬£', 'jpy': '¬•', 'aud': '$'};
        let currentCurrency = localStorage.getItem('currency') || 'eur';
        let priceChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            const cryptoBody = document.getElementById('cryptoBody');
            const searchInput = document.getElementById('searchInput');
            const tableHeaders = document.querySelectorAll('th[id^="sort-"]');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const loadingState = document.getElementById('loading');
            const desktopView = document.getElementById('desktop-view');
            const mobileView = document.getElementById('mobile-view');
            const currencySelector = document.getElementById('currencySelector');
            const currencyHeaderSymbol = document.getElementById('currency-symbol-header');
            
            // Modal Elements
            const infoModal = document.getElementById('infoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const closeModalButton = document.getElementById('closeModal');
            const aboutLink = document.getElementById('about-link');
            const contactLink = document.getElementById('contact-link');
            const termsLink = document.getElementById('terms-link');
            
            // Graph Modal Elements
            const graphModal = document.getElementById('graphModal');
            const graphTitle = document.getElementById('graphTitle');
            const closeGraphModalButton = document.getElementById('closeGraphModal');
            const graphLoading = document.getElementById('graph-loading');
            const chartContainer = document.getElementById('chart-container');
            const timeframeButtons = document.getElementById('timeframeButtons');
            let currentCoinId = null;
            
            // News Feed Elements
            const newsSection = document.getElementById('news-section');
            const newsHeader = document.getElementById('news-header');
            const newsListContainer = document.getElementById('news-list-container');
            const newsToggleIcon = document.getElementById('news-toggle-icon');
            const newsLoading = document.getElementById('news-loading');
            const NEWS_API_URL = 'https://api.rss2json.com/v1/api.json?rss_url=https://decrypt.co/feed';
            const NEWS_CACHE_KEY = 'cryptoNewsCache';
            const NEWS_CACHE_DURATION = 300000; // 5 minutes in milliseconds
            const newsScrollButton = document.getElementById('news-scroll-button');


            const API_URL_BASE = 'https://api.coingecko.com/api/v3/coins/markets?order=market_cap_desc&per_page=100&page=1&sparkline=true';
            const GRAPH_API_BASE_URL = 'https://api.coingecko.com/api/v3/coins/';
            const CACHE_KEY = 'cryptoDataCache';
            const CACHE_DURATION = 30000; // 30 seconds in milliseconds

            let cryptoData = [];
            let currentSortColumn = 'market_cap';
            let sortDirection = 'desc';
            
            // Back to top button
            const backToTopBtn = document.getElementById("backToTopBtn");
            if (backToTopBtn) {
              window.onscroll = function() {
                  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                      backToTopBtn.style.display = "block";
                  } else {
                      backToTopBtn.style.display = "none";
                  }
              };
              backToTopBtn.addEventListener('click', () => {
                  document.body.scrollTop = 0; // For Safari
                  document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
              });
            }
            
            // --- Currency Selector ---
            if (currencySelector) {
                currencySelector.value = currentCurrency;
                if (currencyHeaderSymbol) {
                    currencyHeaderSymbol.textContent = currencySymbols[currentCurrency];
                }
                
                currencySelector.addEventListener('change', (e) => {
                    currentCurrency = e.target.value;
                    localStorage.setItem('currency', currentCurrency);
                    if (currencyHeaderSymbol) {
                        currencyHeaderSymbol.textContent = currencySymbols[currentCurrency];
                    }
                    fetchCryptoData();
                });
            }


            // --- Dark Mode Functionality ---
            const currentTheme = localStorage.getItem('theme') || 'light';
            body.setAttribute('data-theme', currentTheme);
            if (darkModeToggle) {
              darkModeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

              darkModeToggle.addEventListener('click', () => {
                  const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                  body.setAttribute('data-theme', newTheme);
                  localStorage.setItem('theme', newTheme);
                  darkModeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                  // Redraw chart with new colors if it's open
                  if (priceChart) {
                      renderPriceChart(null, null, null); // Call with null to get new theme colors
                  }
              });
            }


            // --- Data Fetching and Rendering ---
            async function fetchCryptoData() {
                console.log('Fetching top 100 crypto data...');
                if (loadingState) loadingState.style.display = 'block';
                if (desktopView) desktopView.style.display = 'none';
                if (mobileView) mobileView.style.display = 'none';

                // Check for cached data
                const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY));
                const now = new Date().getTime();
                if (cachedData && now - cachedData.timestamp < CACHE_DURATION && cachedData.currency === currentCurrency) {
                    console.log('Using cached data.');
                    cryptoData = cachedData.data;
                    renderData(cryptoData);
                    if (loadingState) loadingState.style.display = 'none';
                    updateViewBasedOnWidth();
                    return;
                }

                try {
                    // Corrected API URL for a more stable fetch
                    const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=${currentCurrency}&order=market_cap_desc&per_page=100&page=1&sparkline=true`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    cryptoData = data;
                    // Cache the new data
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        data: data,
                        timestamp: now,
                        currency: currentCurrency
                    }));
                    renderData(cryptoData);
                } catch (error) {
                    console.error('Failed to fetch crypto data:', error);
                    if (desktopView) desktopView.style.display = 'block';
                    if (mobileView) mobileView.style.display = 'none';
                    if (cryptoBody) cryptoBody.innerHTML = '<tr><td colspan="8">Failed to load data. Please try again later.</td></tr>';
                    if (mobileView) mobileView.innerHTML = '<div class="loading-state">Failed to load data. Please try again later.</div>';
                } finally {
                    if (loadingState) loadingState.style.display = 'none';
                    updateViewBasedOnWidth();
                }
            }
            
            function updateViewBasedOnWidth() {
                if (window.innerWidth > 768) {
                    if (desktopView) desktopView.style.display = 'block';
                    if (mobileView) mobileView.style.display = 'none';
                } else {
                    if (desktopView) desktopView.style.display = 'none';
                    if (mobileView) mobileView.style.display = 'block';
                }
            }
            
            window.addEventListener('resize', updateViewBasedOnWidth);

            function renderData(data) {
                renderTable(data);
                renderMobileCards(data);
            }

            function renderSparkline(data, element) {
                const width = 100;
                const height = 30;
                const minPrice = Math.min(...data);
                const maxPrice = Math.max(...data);
                const range = maxPrice - minPrice;
                const points = data.map((price, index) => {
                    const x = (index / (data.length - 1)) * width;
                    const y = height - ((price - minPrice) / range) * height;
                    return `${x},${y}`;
                }).join(' ');

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'sparkline-graph');
                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                
                const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                polyline.setAttribute('points', points);
                polyline.setAttribute('fill', 'none');
                polyline.setAttribute('stroke', data[data.length - 1] >= data[0] ? 'var(--green)' : 'var(--red)');
                polyline.setAttribute('stroke-width', '2');
                svg.appendChild(polyline);
                
                element.innerHTML = '';
                element.appendChild(svg);
            }

            function formatNumber(num) {
                if (num == null) return 'N/A';
                return new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(num);
            }

            function renderTable(data) {
                if (!cryptoBody) return;

                cryptoBody.innerHTML = '';
                const sortedData = [...data].sort((a, b) => {
                    let valA, valB;
                    if (currentSortColumn === 'name') {
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        if (sortDirection === 'asc') return valA.localeCompare(valB);
                        return valB.localeCompare(valA);
                    } else {
                        valA = a[currentSortColumn];
                        valB = b[currentSortColumn];
                        if (valA == null || valB == null) return 0;
                        if (sortDirection === 'asc') return valA - valB;
                        return valB - valA;
                    }
                });

                const currencySymbol = currencySymbols[currentCurrency] || '';

                sortedData.forEach(coin => {
                    const priceChange24h = coin.price_change_percentage_24h != null ? coin.price_change_percentage_24h.toFixed(2) : 'N/A';
                    const priceChange7d = coin.price_change_percentage_7d_in_currency != null ? coin.price_change_percentage_7d_in_currency.toFixed(2) : 'N/A';

                    const row = document.createElement('tr');
                    row.setAttribute('data-coin-id', coin.id);

                    row.innerHTML = `
                        <td>${coin.market_cap_rank}</td>
                        <td>
                            <div class="coin-info">
                                <img src="${coin.image}" onerror="this.onerror=null;this.src='https://placehold.co/24x24/e0e0e0/000000?text=NA'" alt="${coin.name} logo" class="coin-logo">
                                <div>
                                    <strong>${coin.name}</strong>
                                    <span class="coin-symbol">${coin.symbol.toUpperCase()}</span>
                                </div>
                            </div>
                        </td>
                        <td>${currencySymbol}${coin.current_price != null ? coin.current_price.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'}</td>
                        <td class="${priceChange24h !== 'N/A' ? (priceChange24h >= 0 ? 'positive' : 'negative') : ''}">${priceChange24h}%</td>
                        <td class="hide-on-mobile ${priceChange7d !== 'N/A' ? (priceChange7d >= 0 ? 'positive' : 'negative') : ''}">${priceChange7d}%</td>
                        <td class="hide-on-mobile">${currencySymbol}${formatNumber(coin.market_cap)}</td>
                        <td class="hide-on-mobile">${currencySymbol}${formatNumber(coin.total_volume)}</td>
                        <td class="sparkline-container"></td>
                    `;
                    cryptoBody.appendChild(row);

                    if (coin.sparkline_in_7d && coin.sparkline_in_7d.price && coin.sparkline_in_7d.price.length > 0) {
                        const sparklineCell = row.querySelector('.sparkline-container');
                        renderSparkline(coin.sparkline_in_7d.price, sparklineCell);
                    }
                });
            }

            function renderMobileCards(data) {
                if (!mobileView) return;

                mobileView.innerHTML = '';
                const sortedData = [...data].sort((a, b) => {
                    let valA, valB;
                    if (currentSortColumn === 'name') {
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        if (sortDirection === 'asc') return valA.localeCompare(valB);
                        return valB.localeCompare(valA);
                    } else {
                        valA = a[currentSortColumn];
                        valB = b[currentSortColumn];
                        if (valA == null || valB == null) return 0;
                        if (sortDirection === 'asc') return valA - valB;
                        return valB - valA;
                    }
                });

                const currencySymbols = { 'eur': '‚Ç¨', 'usd': '$', 'gbp': '¬£', 'jpy': '¬•', 'aud': '$'};
                const currencySymbol = currencySymbols[currentCurrency] || '';
                
                sortedData.forEach(coin => {
                    const priceChange24h = coin.price_change_percentage_24h != null ? coin.price_change_percentage_24h.toFixed(2) : 'N/A';
                    const priceChange7d = coin.price_change_percentage_7d_in_currency != null ? coin.price_change_percentage_7d_in_currency.toFixed(2) : 'N/A';

                    const card = document.createElement('div');
                    card.classList.add('coin-card');
                    card.setAttribute('data-coin-id', coin.id);
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-name">
                                <img src="${coin.image}" onerror="this.onerror=null;this.src='https://placehold.co/24x24/e0e0e0/000000?text=NA'" alt="${coin.name} logo" class="coin-logo">
                                <div>
                                    <strong>${coin.name}</strong>
                                    <span class="coin-symbol">${coin.symbol.toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="card-price">
                                <strong>${currencySymbol}${coin.current_price != null ? coin.current_price.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'}</strong>
                            </div>
                        </div>
                        <div class="card-info-grid">
                            <div class="card-info-item">
                                <span class="card-label">Rank</span>
                                <span>#${coin.market_cap_rank}</span>
                            </div>
                            <div class="card-info-item">
                                <span class="card-label">24h % Change</span>
                                <span class="${priceChange24h !== 'N/A' ? (priceChange24h >= 0 ? 'positive' : 'negative') : ''}">${priceChange24h}%</span>
                            </div>
                            <div class="card-info-item">
                                <span class="card-label">Market Cap</span>
                                <span>${currencySymbol}${formatNumber(coin.market_cap)}</span>
                            </div>
                            <div class="card-info-item">
                                <span class="card-label">Volume 24h</span>
                                <span>${currencySymbol}${formatNumber(coin.total_volume)}</span>
                            </div>
                        </div>
                    `;
                    mobileView.appendChild(card);
                });

                // Attach click handlers to the new cards
                document.querySelectorAll('.coin-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const coinId = e.currentTarget.getAttribute('data-coin-id');
                        openGraphModal(coinId, 7);
                    });
                });
            }

            // --- Search Functionality ---
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filteredData = cryptoData.filter(coin => 
                        coin.name.toLowerCase().includes(query) || 
                        coin.symbol.toLowerCase().includes(query)
                    );
                    renderData(filteredData);
                });
            }

            // --- Sorting Functionality ---
            tableHeaders.forEach(header => {
                const sortColumn = header.id.replace('sort-', '');
                header.addEventListener('click', () => {
                    tableHeaders.forEach(h => {
                        h.classList.remove('active');
                        h.querySelector('.sort-icon').textContent = '';
                    });

                    if (currentSortColumn === sortColumn) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = sortColumn;
                        sortDirection = 'desc'; 
                    }
                    header.classList.add('active');
                    header.querySelector('.sort-icon').textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                    renderData(cryptoData);
                });
            });

            // --- Modal Functionality ---
            function openModal(title, content) {
                if (modalTitle && modalBody && infoModal) {
                    modalTitle.textContent = title;
                    modalBody.innerHTML = content;
                    infoModal.style.display = 'flex';
                    setTimeout(() => infoModal.classList.add('visible'), 10);
                }
            }

            function closeModal() {
                if (infoModal) {
                    infoModal.classList.remove('visible');
                    setTimeout(() => infoModal.style.display = 'none', 300);
                }
            }

            if (aboutLink) aboutLink.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('About', '<p>This project was created with the assistance of a large language model. The goal is to provide a clean and simple tool for tracking top cryptocurrencies.</p>');
            });

            if (contactLink) contactLink.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('Contact', `<p>For any inquiries, please contact me at: <a href="mailto:esteves7771@gmail.com">esteves7771@gmail.com</a></p>`);
            });

            if (termsLink) termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('Terms & Conditions', '<p>This data is provided "as is" and is not guaranteed to be accurate. The content is for informational purposes only and does not constitute financial advice. Use at your own risk.</p>');
            });

            if (closeModalButton) closeModalButton.addEventListener('click', closeModal);
            if (infoModal) infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) {
                    closeModal();
                }
            });

            // --- Graph Modal Functionality ---
            async function openGraphModal(coinId, days = 7) {
                currentCoinId = coinId;
                if(graphModal){
                    graphModal.style.display = 'flex';
                    setTimeout(() => graphModal.classList.add('visible'), 10);
                }
                if(graphLoading) graphLoading.style.display = 'block';
                if(chartContainer) chartContainer.style.display = 'none';
                if(graphTitle) graphTitle.textContent = 'Loading...';

                // Reset active button state and set the default one
                document.querySelectorAll('.timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
                const defaultButton = document.querySelector(`.timeframe-buttons button[data-days="${days}"]`);
                if (defaultButton) {
                    defaultButton.classList.add('active');
                }

                try {
                    // Corrected API URL for the graph data
                    const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=${currentCurrency}&days=${days}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data && data.prices) {
                        const coin = cryptoData.find(c => c.id === coinId);
                        if(graphTitle) graphTitle.textContent = `${coin.name} Price Chart`;
                        renderPriceChart(data.prices, coin.price_change_percentage_24h, days);
                    } else {
                        if(graphTitle) graphTitle.textContent = 'Data Not Available';
                        if(graphLoading) graphLoading.textContent = 'Failed to load chart data.';
                    }
                } catch (error) {
                    console.error('Failed to fetch chart data:', error);
                    if(graphTitle) graphTitle.textContent = 'Error';
                    if(graphLoading) graphLoading.textContent = 'An error occurred while loading the chart. Please check your network connection.';
                } finally {
                    if(graphLoading) graphLoading.style.display = 'none';
                }
            }

            function closeGraphModal() {
                if (graphModal) {
                    graphModal.classList.remove('visible');
                    setTimeout(() => {
                        graphModal.style.display = 'none';
                        if (priceChart) {
                            priceChart.destroy();
                            priceChart = null; // Clear the reference
                        }
                    }, 300);
                }
            }
            
            if (closeGraphModalButton) closeGraphModalButton.addEventListener('click', closeGraphModal);
            if (graphModal) graphModal.addEventListener('click', (e) => {
                if (e.target === graphModal) {
                    closeGraphModal();
                }
            });

            function renderPriceChart(prices, priceChange, days) {
                if (!chartContainer) return;
                const labels = prices.map(p => new Date(p[0]));
                const data = prices.map(p => p[1]);
                
                // Get theme colors
                const isDarkMode = body.getAttribute('data-theme') === 'dark';
                const chartTextColor = isDarkMode ? '#fff' : '#333';
                const chartGridColor = isDarkMode ? '#000' : '#e0e0e0';
                const chartLineColor = isDarkMode ? '#fff' : (priceChange >= 0 ? '#2ecc71' : '#e74c3c');

                // Clear the existing canvas and create a new one to avoid the error
                chartContainer.innerHTML = '';
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'priceChart';
                chartContainer.appendChild(newCanvas);
                const ctx = newCanvas.getContext('2d');
                
                let timeUnit = 'day';
                if (days === '7') {
                    timeUnit = 'day';
                } else if (days === '30') {
                    timeUnit = 'week';
                } else if (days === '365') {
                    timeUnit = 'month';
                } else if (days === 'max') {
                    timeUnit = 'month';
                } else {
                    timeUnit = 'hour';
                }

                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Price (${currencySymbols[currentCurrency]})`,
                            data: data,
                            borderColor: chartLineColor,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: timeUnit
                                },
                                grid: {
                                    color: chartGridColor
                                },
                                ticks: {
                                    color: chartTextColor
                                }
                            },
                            y: {
                                grid: {
                                    color: chartGridColor
                                },
                                ticks: {
                                    color: chartTextColor
                                }
                            }
                        }
                    }
                });
                chartContainer.style.display = 'block';
            }

            // Click event listener for table rows
            if (cryptoBody) {
                cryptoBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row) {
                        const coinId = row.getAttribute('data-coin-id');
                        // Default to 7 days for the initial graph display
                        openGraphModal(coinId, 7);
                    }
                });
            }
            
            if (mobileView) {
                mobileView.addEventListener('click', (e) => {
                    const card = e.target.closest('.coin-card');
                    if (card) {
                        const coinId = card.getAttribute('data-coin-id');
                        openGraphModal(coinId, 7);
                    }
                });
            }

            // Timeframe button click handler
            if(timeframeButtons){
                timeframeButtons.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        document.querySelectorAll('.timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const days = button.getAttribute('data-days');
                        openGraphModal(currentCoinId, days);
                    }
                });
            }

            // --- News Feed Functionality ---
            async function fetchCryptoNews() {
                if (!newsListContainer || !newsLoading) return;
                
                const cachedNews = JSON.parse(localStorage.getItem(NEWS_CACHE_KEY));
                const now = new Date().getTime();
                if (cachedNews && now - cachedNews.timestamp < NEWS_CACHE_DURATION) {
                    console.log('Using cached news data.');
                    renderNews(cachedNews.data);
                    return;
                }
                
                try {
                    // Corrected API URL for the news feed
                    const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=https://decrypt.co/feed`); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data && data.items) {
                        localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({
                            data: data.items.slice(0, 20), // Fetching and slicing to 20 items
                            timestamp: now
                        }));
                        renderNews(data.items.slice(0, 20));
                    } else {
                        newsLoading.textContent = 'Failed to load news.';
                    }
                } catch (error) {
                    console.error('Failed to fetch news data:', error);
                    newsLoading.textContent = 'An error occurred while loading news.';
                }
            }
            
            function renderNews(newsItems) {
                if(!newsListContainer) return;
                newsListContainer.innerHTML = ''; // Clear loading message
                if (newsItems.length === 0) {
                    newsListContainer.innerHTML = '<div class="news-loading">No news found.</div>';
                    return;
                }
                
                newsItems.forEach(item => {
                    const newsCard = document.createElement('a');
                    newsCard.classList.add('news-item-card');
                    newsCard.href = item.link;
                    newsCard.target = '_blank';
                    
                    const thumbnail = item.enclosure && item.enclosure.link ? item.enclosure.link : 'https://placehold.co/400x200/e0e0e0/000000?text=No+Image';

                    newsCard.innerHTML = `
                        <img src="${thumbnail}" onerror="this.src='https://placehold.co/400x200/e0e0e0/000000?text=No+Image'" alt="News thumbnail">
                        <h4>${item.title}</h4>
                        <p>${item.pubDate}</p>
                    `;
                    newsListContainer.appendChild(newsCard);
                });
            }
            
            if (newsHeader) {
                newsHeader.addEventListener('click', () => {
                    newsListContainer.classList.toggle('visible');
                    newsToggleIcon.textContent = newsListContainer.classList.contains('visible') ? '‚àí' : '+';
                });
            }
            
            if (newsScrollButton) {
                newsScrollButton.addEventListener('click', () => {
                    newsSection.scrollIntoView({ behavior: 'smooth' });
                    if (!newsListContainer.classList.contains('visible')) {
                        newsListContainer.classList.add('visible');
                        newsToggleIcon.textContent = '‚àí';
                    }
                });
            }

            // Initial fetch and auto-refresh
            fetchCryptoData();
            fetchCryptoNews();
            setInterval(fetchCryptoData, 60000); // Refresh crypto data every 60 seconds
            setInterval(fetchCryptoNews, 300000); // Refresh news every 5 minutes
        });
    </script>
</body>
</html>
